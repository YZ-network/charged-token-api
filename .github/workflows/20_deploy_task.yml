name: Deploy snapshot to ECS

on:
  workflow_dispatch:
#  push:
#    branches:
#      - main

concurrency: ${{ github.ref }}

jobs:
  deploy-image:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout project
        uses: actions/checkout@v3

      - name: Setup AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-3
      
      - name: Install dependencies
        shell: bash
        run: |
          # Install ecs cli
          curl -Lo /usr/local/bin/ecs-cli https://amazon-ecs-cli.s3.amazonaws.com/ecs-cli-linux-amd64-latest
          # Install docker compose
          curl -L https://raw.githubusercontent.com/docker/compose-cli/main/scripts/install/install_linux.sh | sh

      - name: Deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_ACCOUNT_ID: 940219468121
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_REPOSITORY: 940219468121.dkr.ecr.eu-west-3.amazonaws.com/yz:snapshot
          GITHUB_SHA: ${{ github.sha }}
        run: |
          ecs-cli compose --ecs-params ecs-params.yml up --launch-type FARGATE
